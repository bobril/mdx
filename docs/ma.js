(function(t){"use strict";var e=__bbb.Mb;var n=__bbb.ac;var a=__bbb.nc;var i=__bbb.ee;var _=__bbb.Qd;var r=__bbb.fe;var o=__bbb.Zd;var d=__bbb.zc;var g=__bbb.Nb;var s=__bbb.dc;var h=__bbb.sc;var c=__bbb.ob;var l=__bbb.Sb;var u=__bbb.ge;var f=__bbb.he;var p=e(t=>t.append("circle").attr("class","start-state").attr("r",n().state.sizeUnit).attr("cx",n().state.padding+n().state.sizeUnit).attr("cy",n().state.padding+n().state.sizeUnit),"drawStartState");var B=e(t=>t.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",n().state.textHeight).attr("class","divider").attr("x2",n().state.textHeight*2).attr("y1",0).attr("y2",0),"drawDivider");var x=e((t,e)=>{const a=t.append("text").attr("x",2*n().state.padding).attr("y",n().state.textHeight+2*n().state.padding).attr("font-size",n().state.fontSize).attr("class","state-title").text(e.id);const i=a.node().getBBox();t.insert("rect",":first-child").attr("x",n().state.padding).attr("y",n().state.padding).attr("width",i.width+2*n().state.padding).attr("height",i.height+2*n().state.padding).attr("rx",n().state.radius);return a},"drawSimpleState");var D=e((t,a)=>{const i=e(function(t,e,a){const i=t.append("tspan").attr("x",2*n().state.padding).text(e);a||i.attr("dy",n().state.textHeight)},"addTspan");const _=t.append("text").attr("x",2*n().state.padding).attr("y",n().state.textHeight+1.3*n().state.padding).attr("font-size",n().state.fontSize).attr("class","state-title").text(a.descriptions[0]);const r=_.node().getBBox();const o=r.height;const d=t.append("text").attr("x",n().state.padding).attr("y",o+n().state.padding*.4+n().state.dividerMargin+n().state.textHeight).attr("class","state-description");let g=!0;let s=!0;a.descriptions.forEach(function(t){if(!g){i(d,t,s);s=!1}g=!1});const h=t.append("line").attr("x1",n().state.padding).attr("y1",n().state.padding+o+n().state.dividerMargin/2).attr("y2",n().state.padding+o+n().state.dividerMargin/2).attr("class","descr-divider");const c=d.node().getBBox();const l=Math.max(c.width,r.width);h.attr("x2",l+3*n().state.padding);t.insert("rect",":first-child").attr("x",n().state.padding).attr("y",n().state.padding).attr("width",l+2*n().state.padding).attr("height",c.height+o+2*n().state.padding).attr("rx",n().state.radius);return t},"drawDescrState");var k=e((t,e,a)=>{const i=n().state.padding;const _=2*n().state.padding;const r=t.node().getBBox();const o=r.width;const d=r.x;const g=t.append("text").attr("x",0).attr("y",n().state.titleShift).attr("font-size",n().state.fontSize).attr("class","state-title").text(e.id);const s=g.node().getBBox();const h=s.width+_;let c=Math.max(h,o);c===o&&(c=c+_);let l;const u=t.node().getBBox();e.docl=d-i;h>o&&(l=(o-c)/2+i);Math.abs(d-u.x)<i&&h>o&&(l=d-(h-o)/2);const f=1-n().state.textHeight;t.insert("rect",":first-child").attr("x",l).attr("y",f).attr("class",a?"alt-composit":"composit").attr("width",c).attr("height",u.height+n().state.textHeight+n().state.titleShift+1).attr("rx","0");g.attr("x",l+i);h<=o&&g.attr("x",d+(c-_)/2-h/2+i);t.insert("rect",":first-child").attr("x",l).attr("y",n().state.titleShift-n().state.textHeight-n().state.padding).attr("width",c).attr("height",n().state.textHeight*3).attr("rx",n().state.radius);t.insert("rect",":first-child").attr("x",l).attr("y",n().state.titleShift-n().state.textHeight-n().state.padding).attr("width",c).attr("height",u.height+3+2*n().state.textHeight).attr("rx",n().state.radius);return t},"addTitleAndBox");var A=e(t=>{t.append("circle").attr("class","end-state-outer").attr("r",n().state.sizeUnit+n().state.miniPadding).attr("cx",n().state.padding+n().state.sizeUnit+n().state.miniPadding).attr("cy",n().state.padding+n().state.sizeUnit+n().state.miniPadding);return t.append("circle").attr("class","end-state-inner").attr("r",n().state.sizeUnit).attr("cx",n().state.padding+n().state.sizeUnit+2).attr("cy",n().state.padding+n().state.sizeUnit+2)},"drawEndState");var b=e((t,e)=>{let a=n().state.forkWidth;let i=n().state.forkHeight;if(e.parentId){let t=a;a=i;i=t}return t.append("rect").style("stroke","black").style("fill","black").attr("width",a).attr("height",i).attr("x",n().state.padding).attr("y",n().state.padding)},"drawForkJoinState");var J=e((t,e,i,_)=>{let r=0;const o=_.append("text");o.style("text-anchor","start");o.attr("class","noteText");let d=t.replace(/\r\n/g,"<br/>");d=d.replace(/\n/g,"<br/>");const g=d.split(a.lineBreakRegex);let s=1.25*n().state.noteMargin;for(const t of g){let a=t.trim();if(a.length>0){let t=o.append("tspan");t.text(a);if(s===0){let e=t.node().getBBox();s+=e.height}r+=s;t.attr("x",e+n().state.noteMargin);t.attr("y",i+r+1.25*n().state.noteMargin)}}return{textWidth:o.node().getBBox().width,textHeight:r}},"_drawLongText");var m=e((t,e)=>{e.attr("class","state-note");const a=e.append("rect").attr("x",0).attr("y",n().state.padding);const i=e.append("g");const{textWidth:_,textHeight:r}=J(t,0,0,i);a.attr("height",r+2*n().state.noteMargin);a.attr("width",_+n().state.noteMargin*2);return a},"drawNote");var w=e(function(t,e){const a=e.id;const i={id:a,label:e.id,width:0,height:0};const _=t.append("g").attr("id",a).attr("class","stateGroup");e.type==="start"&&p(_);e.type==="end"&&A(_);(e.type==="fork"||e.type==="join")&&b(_,e);e.type==="note"&&m(e.note.text,_);e.type==="divider"&&B(_);e.type==="default"&&e.descriptions.length===0&&x(_,e);e.type==="default"&&e.descriptions.length>0&&D(_,e);const r=_.node().getBBox();i.width=r.width+2*n().state.padding;i.height=r.height+2*n().state.padding;return i},"drawState");var Y=0;var v=e(function(t,s,h){const c=e(function(t){switch(t){case i.relationType.AGGREGATION:return"aggregation";case i.relationType.EXTENSION:return"extension";case i.relationType.COMPOSITION:return"composition";case i.relationType.DEPENDENCY:return"dependency"}},"getRelationType");s.points=s.points.filter(t=>!Number.isNaN(t.y));const l=s.points;const u=_().x(function(t){return t.x}).y(function(t){return t.y}).curve(r);const f=t.append("path").attr("d",u(l)).attr("id","edge"+Y).attr("class","transition");let p="";n().state.arrowMarkerAbsolute&&(p=o(!0));f.attr("marker-end","url("+p+"#"+c(i.relationType.DEPENDENCY)+"End)");if(h.title!==void 0){let e=t.append("g").attr("class","stateLabel"),{x:i,y:_}=d.calcLabelPosition(s.points),r=a.getRows(h.title),o=0,c=[],l=0,u=0;for(let t=0;t<=r.length;t++){let n=e.append("text").attr("text-anchor","middle").text(r[t]).attr("x",i).attr("y",_+o),a=n.node().getBBox();l=Math.max(l,a.width);u=Math.min(u,a.x);g.info(a.x,i,_+o);if(o===0){let t=n.node().getBBox();o=t.height;g.info("Title height",o,_)}c.push(n)}let f=o*r.length;if(r.length>1){let t=(r.length-1)*o*.5;c.forEach((e,n)=>e.attr("y",_+n*o-t));f=o*r.length}let p=e.node().getBBox();e.insert("rect",":first-child").attr("class","box").attr("x",i-l/2-n().state.padding/2).attr("y",_-f/2-n().state.padding/2-3.5).attr("width",l+n().state.padding).attr("height",f+n().state.padding);g.info(p)}Y++},"drawEdge");var C;var Z={};var K=e(function(){},"setConf");var H=e(function(t){t.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z")},"insertMarkers");var y=e(function(t,e,a,i){C=n().state;const _=n().securityLevel;let r;_==="sandbox"&&(r=s("#i"+e));const o=_==="sandbox"?s(r.nodes()[0].contentDocument.body):s("body");const d=_==="sandbox"?r.nodes()[0].contentDocument:document;g.debug("Rendering diagram "+t);const c=o.select(`[id='${e}']`);H(c);const l=i.db.getRootDoc();R(l,c,void 0,!1,o,d,i);const u=C.padding;const f=c.node().getBBox();const p=f.width+u*2;const B=f.height+u*2;const x=p*1.75;h(c,B,x,C.useMaxWidth);c.attr("viewBox",`${f.x-C.padding}  ${f.y-C.padding} `+p+" "+B)},"draw");var S=e(t=>t?t.length*C.fontSizeFactor:1,"getLabelWidth");var R=e((t,e,n,i,_,r,o)=>{const d=new c({compound:!0,multigraph:!0});let s;let h=!0;for(s=0;s<t.length;s++){if(t[s].stmt==="relation"){h=!1;break}}if(n){d.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:h?1:C.edgeLengthFactor,nodeSep:h?1:50,isMultiGraph:!0})}else{d.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:h?1:C.edgeLengthFactor,nodeSep:h?1:50,ranker:"tight-tree",isMultiGraph:!0})}d.setDefaultEdgeLabel(function(){return{}});const u=o.db.getStates();const f=o.db.getRelations();const p=Object.keys(u);for(const t of p){let a=u[t];n&&(a.parentId=n);let g;if(a.doc){let t=e.append("g").attr("id",a.id).attr("class","stateGroup");g=R(a.doc,t,a.id,!i,_,r,o);t=k(t,a,i);let n=t.node().getBBox();g.width=n.width;g.height=n.height+C.padding/2;Z[a.id]={y:C.compositTitleSize}}else{g=w(e,a,d)}if(a.note){let t={descriptions:[],id:a.id+"-note",note:a.note,type:"note"},n=w(e,t,d);if(a.note.position==="left of"){d.setNode(g.id+"-note",n);d.setNode(g.id,g)}else{d.setNode(g.id,g);d.setNode(g.id+"-note",n)}d.setParent(g.id,g.id+"-group");d.setParent(g.id+"-note",g.id+"-group")}else{d.setNode(g.id,g)}}g.debug("Count=",d.nodeCount(),d);let B=0;f.forEach(function(t){B++;g.debug("Setting edge",t);d.setEdge(t.id1,t.id2,{relation:t,width:S(t.title),height:C.labelHeight*a.getRows(t.title).length,labelpos:"c"},"id"+B)});l(d);g.debug("Graph after layout",d.nodes());const x=e.node();d.nodes().forEach(function(t){if(t!==void 0&&d.node(t)!==void 0){g.warn("Node "+t+": "+JSON.stringify(d.node(t)));_.select("#"+x.id+" #"+t).attr("transform","translate("+(d.node(t).x-d.node(t).width/2)+","+(d.node(t).y+(Z[t]?Z[t].y:0)-d.node(t).height/2)+" )");_.select("#"+x.id+" #"+t).attr("data-x-shift",d.node(t).x-d.node(t).width/2);let e=r.querySelectorAll("#"+x.id+" #"+t+" .divider");e.forEach(t=>{const e=t.parentElement;let n=0;let a=0;if(e){e.parentElement&&(n=e.parentElement.getBBox().width);a=parseInt(e.getAttribute("data-x-shift"),10);Number.isNaN(a)&&(a=0)}t.setAttribute("x1",0-a+8);t.setAttribute("x2",n-a-8)})}else{g.debug("No Node "+t+": "+JSON.stringify(d.node(t)))}});let D=x.getBBox();d.edges().forEach(function(t){if(t!==void 0&&d.edge(t)!==void 0){g.debug("Edge "+t.v+" -> "+t.w+": "+JSON.stringify(d.edge(t)));v(e,d.edge(t),d.edge(t).relation)}});D=x.getBBox();const A={id:n?n:"root",label:n?n:"root",width:0,height:0};A.width=D.width+2*C.padding;A.height=D.height+2*C.padding;g.debug("Doc rendered",A,d);return A},"renderDoc");var F={setConf:K,draw:y};var T={parser:u,get db(){return new i(1)},renderer:F,styles:f,init:e(t=>{t.state||(t.state={});t.state.arrowMarkerAbsolute=t.arrowMarkerAbsolute},"init")};var E={diagram:T};__bbb.L=E}).call(this)